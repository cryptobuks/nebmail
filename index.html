<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width,initial-scale=0.5, maximum-scale=0.5, minimum-scale=0.5, user-scalable=no">
	<meta name="x5-fullscreen" content="true">
	<meta name="full-screen" content="yes">

	<title>星云邮件-一个去中心化的加密邮件服务</title>
	<link rel="stylesheet" href="lib/bootstrap-4.0.0-dist/css/bootstrap.min.css">
	<link rel=stylesheet href="css/base.css">
	<link rel=stylesheet href="css/ui-block.css">
	<link rel="stylesheet" href="css/main.css">
	<link rel="shortcut icon" type="image/png" href="img/logo.png"/>

	<script src="lib/jquery-3.3.1.min.js"></script>
	<script src=lib/nebulas.js></script>
	<script src=lib/nebPay.js></script>
	<script src=lib/bootstrap-4.0.0-dist/js/bootstrap.min.js></script>
	<script src=lib/jquery.qrcode.min.js data-depends=jquery></script>
	<script src=lib/bootbox.min.js data-depends="bootstrap jquery.slim"></script>
	<script src=lib/Blob.js></script>
	<script src=lib/FileSaver.min.js></script>
	<script src=js/1-localSave.js></script>
	<script src=js/home.v1.js></script>
	<script src=js/i18n.js data-depends=jquery.slim></script>
	<script src=js/ui-block.js data-depends="bootbox blockies jquery.slim i18n.js nebulas.js"></script>
</head>

<body>
	<div class="row">
		<div class="col-md-2 d-none d-md-block bg-light sidebar">
			<div class="sidebar-sticky" style="margin-top: 80px;">
				<ul class="nav flex-column">
					<li class="nav-item">
						<a class="nav-link active" go-tab-link="domains-tab-nav" href="javascript: void(0)">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
							 stroke-linecap="round" stroke-linejoin="round" class="feather feather-home">
								<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
								<polyline points="9 22 9 12 15 12 15 22"></polyline>
							</svg>
							首页
							<span class="sr-only">(current)</span>
						</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" go-tab-link="domains-tab-nav" href="javascript: void(0)">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
							 stroke-linecap="round" stroke-linejoin="round" class="feather feather-shopping-cart">
								<circle cx="9" cy="21" r="1"></circle>
								<circle cx="20" cy="21" r="1"></circle>
								<path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
							</svg>
							注册域名
						</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" go-tab-link="view-domain-tab-nav" href="javascript: void(0)">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
							 stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
								<path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
								<polyline points="13 2 13 9 20 9"></polyline>
							</svg>
							查看域名
						</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" go-tab-link="view-address-domains-tab-nav" href="javascript: void(0)">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
							 stroke-linecap="round" stroke-linejoin="round" class="feather feather-users">
								<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
								<circle cx="9" cy="7" r="4"></circle>
								<path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
								<path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
							</svg>
							已有域名
						</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" go-tab-link="sendmail-tab-nav" href="javascript: void(0)" data-toggle="pill" role="tab" aria-controls="sendmail-tab">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
							 stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus-circle">
								<circle cx="12" cy="12" r="10"></circle>
								<line x1="12" y1="8" x2="12" y2="16"></line>
								<line x1="8" y1="12" x2="16" y2="12"></line>
							</svg>
							发送邮件
						</a>

					</li>
					<li class="nav-item">
						<a class="nav-link" go-tab-link="mailbox-tab-nav" href="javascript: void(0)">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
							 stroke-linecap="round" stroke-linejoin="round" class="feather feather-layers">
								<polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
								<polyline points="2 17 12 22 22 17"></polyline>
								<polyline points="2 12 12 17 22 12"></polyline>
							</svg>
							查看邮件
						</a>
					</li>
				</ul>
			</div>
		</div>
		<main class="col-md-9 ml-sm-auto col-lg-10 px-4">
			<div class="">
				<div class="logo">
					<img src="img/logo.png" style="width: 80px; margin-top: 4px; float: left;" alt="">
					<div class="name" style="font-size: 40px; word-break: keep-all;">星云邮件，一个去中心化的加密邮件服务</div>
				</div>
				<div id="notify-install-extension" class="alert alert-info" role="alert">
					NOTE: 为了使用星云邮件服务，请先安装
					<a target="_blank" href="https://github.com/ChengOrangeJu/WebExtensionWallet">星云链浏览器插件</a>
				</div>
				<div>
					<a href="https://github.com/zoowii/nebmail" target="_blank">
						<img style="position: fixed; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"
						 alt="Fork me on GitHub">
					</a>
				</div>
				<div class="" style="margin: auto;">
					<div class="author2 alert alert-primary" role="alert">
						<p>捐赠地址:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n1aJXsZCGw4bsn5UJaqASrsmUqbfVPoeRG6 <button class="btn btn-primary btn-sm" id="donate-btn">捐赠</button></p>
						<p>邮件合约地址: &nbsp;&nbsp;<a class="contract-address-show" target="_blank" href="javascript: void(0)"></a></p>
					</div>
				</div>
				<div id="error-notify-panel" class="alert alert-danger" role="alert">

				</div>

				<ul class="nav nav-tabs" id="myTab" role="tablist">
					<li class="nav-item">
						<a class="nav-link active" id="domains-tab-nav" data-toggle="tab" href="#domains-tab" role="tab" aria-controls="domains"
						 aria-selected="true">注册域名</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" id="view-domain-tab-nav" data-toggle="tab" href="#view-domain-tab" role="tab" aria-controls="view-domain"
						 aria-selected="false">查看域名信息</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" id="view-address-domains-tab-nav" data-toggle="tab" href="#view-address-domains-tab" role="tab" aria-controls="view-address-domains"
						 aria-selected="false">查找已有域名</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" id="sendmail-tab-nav" data-toggle="tab" href="#sendmail-tab" role="tab" aria-controls="sendmail" aria-selected="false">发送邮件</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" id="mailbox-tab-nav" data-toggle="tab" href="#mailbox-tab" role="tab" aria-controls="mailbox" aria-selected="false">查收邮件</a>
					</li>
				</ul>
				<div class="tab-content" id="myTabContent">
					<div class="tab-pane fade show active" id="domains-tab" role="tabpanel" aria-labelledby="domains-tab-nav">
						<div class="add_banner" style="margin-top: 20px;">
							<button type="button" class="btn btn-danger" id="toggle-wallet-show-btn">显示/隐藏钱包</button>
							<div class="hide" id="neb-wallet-panel">
								<div class="container select-wallet-file"></div>

								<div id=walletinfo class="container transaction">
									<div class=row>
										<div class=col>
											<div class=form-group>
												<label for=address data-i18n=wallet-info/your-addr>你的地址</label>
												<input type=text class=form-control id=address disabled>
											</div>
											<div class=form-group>
												<label for=amount data-i18n=wallet-info/acc-balance>账户余额 : </label>
												<input type=text id=amount class=form-control disabled>
											</div>
											<div class=form-group>
												<label for=keystore>
													<span data-i18n=keystore-file>Keystore File</span>
													(JSON / Recommended / Encrypted)
												</label>
												<button type=submit class="btn btn-default col-xs-12 col-sm-12 col-md-12 text-center" id=keystore data-i18n=download>下载</button>
											</div>
											<div class=form-group>
												<label for=password data-i18n=wallet-info/private-key>Private Key (unencrypted)</label>
												<input type=password id=password class=form-control disabled>
												<div>
													<input id=togglePassword type=checkbox>
													<label for=togglePassword>visible</label>
												</div>
											</div>
										</div>
										<div class="col qr_code">
											<div class=text-center>
												<label for=addressqr data-i18n=wallet-info/your-addr>Your Address</label>
												<div class=form-group id=addressqr></div>
											</div>
											<div class="display-none key_qr text-center">
												<label for=privateqr data-i18n=wallet-info/private-key>Private Key (unencrypted)</label>
												<div class=form-group id=privateqr></div>
											</div>
										</div>
									</div>
								</div>

							</div>
						</div>
						<div style="width: 80%; margin: 0 auto;">
							<form>
								<div class="form-group row">
									<label for="register_domain_address_input" class="col-sm-2 col-form-label">你的NAS地址: </label>
									<div class="col-sm-10">
										<input type="text" id="register_domain_address_input" class="form-control" style="width: 100%; background: white;" placeholder="在此处贴上你的NAS地址，或者用上面按钮打开钱包文件"
										 value="" />
									</div>
								</div>
								<div class="form-group row">
									<label for="register_domain_pubkey_input" class="col-sm-2 col-form-label">你的NAS公钥: </label>
									<div class="col-sm-10">
										<textarea rows="3" class="form-control" style="width: 100%; background: white;" id="register_domain_pubkey_input" placeholder="在此处贴上你的NAS公钥，或者用上面按钮打开钱包文件"></textarea>
									</div>
								</div>
						</div>
						<div class="add_banner">
							<h4 style="margin: 0 auto;
					width: 100%;
					padding: 20px 0">在星云链上注册域名服务</h4>
							<div>
								<div class="input-group mb-3" style="width: 50%;">
									<input type="text" class="form-control" placeholder="域名(只能包含字母或数字并且以字母开头)" id="register_domain_input" aria-label="域名(只能包含字母或数字并且以字母开头)"
									 aria-describedby="basic-addon2" style="background: white;">
									<div class="input-group-append">
										<span class="input-group-text" id="basic-addon2">.nas</span>
									</div>
								</div>
								<button id="register_domain_btn" type="button" class="btn btn-danger">注册</button>
							</div>
						</div>
					</div>

					<div class="tab-pane fade" id="view-domain-tab" role="tabpanel" aria-labelledby="view-domain-tab-nav">
						<div class="add_banner">
							<h4 style="margin: 0 auto;width: 100%;padding: 20px 0">在星云链上查看域名信息</h4>
							<div>
								<div class="input-group mb-3" style="width: 50%;">
									<input type="text" class="form-control" placeholder="域名(只能包含字母或数字并且以字母开头)" id="query_domain_input" aria-label="域名(只能包含字母或数字并且以字母开头)"
									 aria-describedby="basic-addon3" style="background: white;">
									<div class="input-group-append">
										<span class="input-group-text" id="basic-addon3">.nas</span>
									</div>
								</div>
								<button id="query_domain_btn" type="button" class="btn btn-danger">查询</button>
							</div>
							<div class="hide" id="query_domain_info_result_panel" style="color: red; padding: 10px">
								<span>域名拥有者：</span>
								<span class="-domain-owner-span"></span>
								<br>
								<span>域名关联数据:</span>
								<br>
								<div class="-domain-content-panel"></div>
								<br>
								<span>域名: </span>
								<span class="-domain-host-span"></span>
								<span>.nas</span>
								<br>
							</div>
						</div>
					</div>

					<div class="tab-pane fade" id="view-address-domains-tab" role="tabpanel" aria-labelledby="view-address-domains-tab-nav">
						<div class="add_banner">
							<div class="add_banner">
								<h4 style="margin: 0 auto;
										width: 100%;
										padding: 20px 0">在星云链上查看地址拥有的域名</h4>
								<div>
									<input type="text" class="form-control" id="query_user_domains_input" style="width: 50%; background: white;" placeholder="输入用户地址">
									<button id="query_user_domains_btn" type="button" class="btn btn-danger">查询</button>
								</div>
								<div class="hide" id="query_user_domains_result_panel" style="color: red; padding: 10px">

								</div>
							</div>
						</div>
					</div>

					<div class="tab-pane fade" id="sendmail-tab" role="tabpanel" aria-labelledby="sendmail-tab-nav">
						<div class="add_banner">
							<h4 style="margin: 0 auto;width: 100%;padding: 20px 0">发送邮件</h4>
							<div>
								<span>发件人地址(你自己的星云域名，比如 abc.nas)</span>
								<br>
								<input type="text" id="send_mail_from_domain_input" style="width: 100%;">
								<br>
								<span>收件人地址(星云域名，比如 zoowii.nas)</span>
								<br>
								<input type="text" id="send_mail_to_domain_input" style="width: 100%;">
								<br>
								<span>邮件内容(邮件内容会使用收件人公钥进行加密，只有收件人可以凭私钥读取)</span>
								<textarea id="send_mail_content_input" style="width: 100%;" rows="10"></textarea>
								<br>
								<button id="send_mail_btn" type="button" class="btn btn-danger">发送</button>
							</div>
							<div class="hide" id="query_user_domains_result_panel" style="color: red; padding: 10px">

							</div>
						</div>
					</div>
					<div class="tab-pane fade" id="mailbox-tab" role="tabpanel" aria-labelledby="mailbox-tab-nav">
						<div class="add_banner">
							<h4 style="margin: 0 auto;
							width: 100%;
							padding: 20px 0">在星云链上查看域名收到的邮件(在本页头部打开钱包后才可以解密邮件内容)</h4>
							<div>
								<div class="input-group mb-3" style="width: 50%;">
									<input type="text" class="form-control" placeholder="域名(只能包含字母或数字并且以字母开头)" id="query_domain_mails_input" aria-label="域名(只能包含字母或数字并且以字母开头)"
									 aria-describedby="basic-addon3" style="background: white;">
									<div class="input-group-append">
										<span class="input-group-text" id="basic-addon3">.nas</span>
									</div>
								</div>
								<button id="query_domain_mails_btn" type="button" class="btn btn-danger">查询</button>
							</div>
							<div class="hide" id="query_domain_mails_result_panel" style="color: red; padding: 10px"></div>
						</div>
					</div>
				</div>

			</div>

		</main>
	</div>
	<script>
		// wallet file operations script
		var nebulas = require("nebulas"),
			Account = nebulas.Account,
			Neb = nebulas.Neb,
			Transaction = nebulas.Transaction,
			Utils = nebulas.Utils,
			neb = new Neb(),
			gAccount, gFileJson;

		neb.setRequest(new nebulas.HttpRequest(localSave.getItem("apiPrefix") || "https://mainnet.nebulas.io/"));
		$("#keystore").on("click", onClickKeystore);
		$("#togglePassword").on("change", onChangeTogglePassword);

		uiBlock.insert({
			footer: ".footer",
			header: ".header",
			logoMain: ".logo-main",
			selectWalletFile: [".select-wallet-file", onUnlockFile]
		});

		var currentAccount = null;

		function onUnlockFile(swf, fileJson, account, password) {
			try {
				gAccount = account;
				gFileJson = fileJson;
				account.fromKey(fileJson, password);

				currentAccount = account;
				simulateFromAddress = currentAccount.getAddressString();

				$("#register_domain_address_input").val(account.getAddressString());
				$("#register_domain_pubkey_input").val(account.getPublicKeyString());

				showSuccessInfo("打开钱包成功");
			} catch (e) {
				// this catches e thrown by nebulas.js!account

				bootbox.dialog({
					backdrop: true,
					onEscape: true,
					message: localSave.getItem("lang") == "en" ? e : "keystore 文件错误, 或者密码错误",
					size: "large",
					title: "Error"
				});
			}
		}

		function onClickKeystore() {
			var blob = new Blob([JSON.stringify(gFileJson)], { type: "application/json; charset=utf-8" });
			saveAs(blob, gAccount.getAddressString());
		}

		function onChangeTogglePassword(e) {
			if (e.target.checked) {
				$("#password").prop("type", "text");
				$(".key_qr").removeClass("display-none");
			} else {
				$("#password").prop("type", "password");
				$(".key_qr").addClass("display-none");
			}
		}
	</script>
	<script>

		"use strict";

		var dappTestNetAddress = "n1zYsYymcnZ3RSYW7529ZfsJLj52cbL1QRL";
		var dappMainNetAddress = "n1z6zsFpEBi8M7HJvgNrNUQGLKrwxszMuLJ";

		var useTestNet = location.search.indexOf('testnet=true')>=0 ? true : false;

		var dappAddress = useTestNet ? dappTestNetAddress : dappMainNetAddress;

		$(".contract-address-show").text(dappAddress);
		$(".contract-address-show").attr('href', "https://explorer.nebulas.io/#/address/" + dappAddress);

		var nebulas = require("nebulas"),
			Account = nebulas.Account,
			neb = new nebulas.Neb();
		neb.setRequest(new nebulas.HttpRequest(useTestNet ? "https://testnet.nebulas.io" : "https://mainnet.nebulas.io"));

		function isLetter(str) {
			return str.length === 1 && str.match(/[a-z]/i);
		}

		function isDigit(str) {
			return str.length === 1 && str.match(/\d/i);
		}

		function isValidHostFormat(host) {
			if (host === '') {
				return false;
			}
			if (host.length > 20) {
				return false;
			}
			if (!isLetter(host[0])) {
				return false;
			}
			for (var i = 1; i < host.length; i++) {
				if (!isLetter(host[i]) && !isDigit(host[i])) {
					return false;
				}
			}
			return true;
		}

		function Uint8ToBase64(u8Arr) {
			var CHUNK_SIZE = 0x8000; //arbitrary number
			var index = 0;
			var length = u8Arr.length;
			var result = '';
			var slice;
			while (index < length) {
				slice = u8Arr.subarray(index, Math.min(index + CHUNK_SIZE, length));
				result += String.fromCharCode.apply(null, slice);
				index += CHUNK_SIZE;
			}
			return btoa(result);
		}

		function showErrorInfo(error) {
			console.log('info: ', error);
			if(error.msg) {
				error = error.msg;
			}
			error = error || "出现错误";
			$("#error-notify-panel").html(error);
			$("#error-notify-panel").show(200);
			setTimeout(function() {
				$("#error-notify-panel").hide(1000);
			}, 4000);
		}

		var dappAuthorAccount = Account.fromAddress('n1aJXsZCGw4bsn5UJaqASrsmUqbfVPoeRG6'); // 不要用这个地址太多次
		var simulateFromAddress = dappAuthorAccount.getAddressString(); // 模拟执行时使用的地址

		// TODO: 邮件内容长度限制目前15字符，code length error，感觉不是参数长度限制，其他方面限制。需要想办法绕过

		$(function() {
			setTimeout(function() {
				if (!window.webExtensionWallet) {
					showErrorInfo('扩展钱包未安装，请先安装');
					return
				}

			}, 3000);
		});
		// TODO： 更新domain的content，子域名，转移domain所有权

		$("#donate-btn").click(function() {
			var toAddress = dappAuthorAccount.getAddressString();
			var value = "1";
			var gas_price = "1000000";
			var gas_limit = "2000000";

			callOnChainTx(simulateFromAddress, toAddress, value, '0', gas_price, gas_limit, null, null,
				function(data) {
					showSuccessInfo("捐赠成功，你得到一份作者的感谢！");
				});
		});


		$("#register_domain_btn").click(function () {
			var domainHost = $("#register_domain_input").val().trim();
			if (!domainHost || !isValidHostFormat(domainHost)) {
				showErrorInfo("域名格式错误");
				return;
			}
			var pubkey = $("#register_domain_pubkey_input").val().trim();
			if (pubkey.length < 1) {
				showErrorInfo("请贴入你的公钥，或者从本网页中打开钱包");
				return;
			}
			var address = $("#register_domain_address_input").val().trim();
			if (address.length < 1) {
				showErrorInfo("请贴入你的地址，或者从本网页中打开钱包");
				return;
			}

			var value = "0";
			var gas_price = "1000000"
			var gas_limit = "2000000"
			var callFunction = "registerDomain";
			var callArgs = JSON.stringify([domainHost, JSON.stringify({ pubKey: pubkey, address: address })]);

			callOnChainTx(simulateFromAddress, dappAddress, value, '0', gas_price, gas_limit, callFunction, callArgs,
				function(data) {
					showSuccessInfo("域名注册成功");
				});
		});

		function sendMail(fromDomainItem, toDomainItem, encryptedContent) {
			var value = "0";
			var gas_price = "1000000"
			var gas_limit = "2000000"
			var callFunction = "sendMail";
			var callArgs = JSON.stringify([fromDomainItem.host, toDomainItem.host, encryptedContent]);

			callOnChainTx(fromDomainItem.owner, dappAddress, value, '0', gas_price, gas_limit, callFunction, callArgs,
				function(data) {
					showSuccessInfo("邮件发送完成");
				});
		}

		$("#send_mail_btn").click(function () {
			var toHost = $("#send_mail_to_domain_input").val().trim();
			if (toHost.endsWith('.nas')) {
				toHost = toHost.substring(0, toHost.length - '.nas'.length).trim();
			}
			if (!toHost) {
				showErrorInfo("请填写收件人域名");
				return;
			}
			var fromHost = $("#send_mail_from_domain_input").val().trim();
			if (fromHost.endsWith('.nas')) {
				fromHost = fromHost.substring(0, fromHost.length - '.nas'.length).trim();
			}
			if (!fromHost) {
				showErrorInfo("请填写发件人域名");
				return;
			}

			var content = $("#send_mail_content_input").val().trim(); // 邮件内容，需要用对方公钥加密
			if(content.length > 2000) {
				showErrorInfo("因为智能合约参数长度限制，暂时邮件内容限制2000个字");
				return;
			}

			var value = "0";
			var gas_price = "1000000"
			var gas_limit = "2000000"
			var callFunction = "getDomains";
			var callArgs = JSON.stringify([[fromHost, toHost]]);
			var contract = {
				"function": callFunction,
				"args": callArgs
			}

			neb.api.call(simulateFromAddress, dappAddress, value, '0', gas_price, gas_limit, contract).then(function (resp) {
				console.log(resp);
				if (resp.execute_err.length > 0) {
					throw new Error(resp.execute_err);
				}
				var result = JSON.parse(resp.result);
				if (!result || result.length < 2 || !result[0] || !result[1]) {
					throw new Error("此域名没找到");
				}
				var fromDomainItem = result[0];
				var toDomainItem = result[1];
				// 用对方公钥对邮件内容进行加密
				var toDomainPubKey = JSON.parse(toDomainItem.content)['pubKey'];
				var toEncryptPubKey = convertHexToBinary('04' + toDomainPubKey); // 加了04前缀的公钥
				console.log(toEncryptPubKey);
				eccrypto.encrypt(toEncryptPubKey, Buffer(content)).then(function (encryptedContent) {
					if (!encryptedContent) {
						showErrorInfo("加密失败");
						return;
					}
					sendMail(fromDomainItem, toDomainItem, encryptedContent);
				});
			}).catch(function (err) {
				console.log("error:" + err.message);
				showErrorInfo(err.message);
			});
		});

		$("#query_domain_btn").click(function () {
			var domainHost = $("#query_domain_input").val().trim();
			if (!domainHost || !isValidHostFormat(domainHost)) {
				showErrorInfo("域名格式错误");
				return;
			}
			var value = "0";
			var gas_price = "1000000"
			var gas_limit = "2000000"
			var callFunction = "getDomain";
			var callArgs = JSON.stringify([domainHost]);
			var contract = {
				"function": callFunction,
				"args": callArgs
			}

			neb.api.call(simulateFromAddress, dappAddress, value, '0', gas_price, gas_limit, contract).then(function (resp) {
				console.log(resp);
				if (resp.execute_err.length > 0) {
					throw new Error(resp.execute_err);
				}
				var result = JSON.parse(resp.result);
				if (!result) {
					throw new Error("此域名没找到");
				}
				var $resultPanel = $("#query_domain_info_result_panel");
				$resultPanel.find('.-domain-owner-span').text(result.owner);
				$resultPanel.find('.-domain-content-panel').text(result.content);
				$resultPanel.find('.-domain-host-span').text(result.host);
				$resultPanel.show();
			}).catch(function (err) {
				showErrorInfo(err.message);
			});
		});

		$("#query_domain_mails_btn").click(function () {
			var domainHost = $("#query_domain_mails_input").val().trim();
			if (!domainHost || !isValidHostFormat(domainHost)) {
				showErrorInfo("域名格式错误");
				return;
			}
			var value = "0";
			var gas_price = "1000000"
			var gas_limit = "2000000"
			var callFunction = "getHostReceivedMails";
			var callArgs = JSON.stringify([domainHost]);
			var contract = {
				"function": callFunction,
				"args": callArgs
			}

			neb.api.call(simulateFromAddress, dappAddress, value, '0', gas_price, gas_limit, contract).then(function (resp) {
				console.log(resp);
				if (resp.execute_err.length > 0) {
					throw new Error(resp.execute_err);
				}
				var mails = JSON.parse(resp.result);
				var $resultPanel = $("#query_domain_mails_result_panel");
				$resultPanel.html('');
				if(mails.length < 1) {
					showErrorInfo("此地址至今没有收到邮件");
					return;
				}
				var $ul = $("<ul></ul>");
				for (var i = 0; i < mails.length; i++) {
					var mail = mails[i];
					var $li = $("<li></li>");
					var $div = $("<div></div>");
					$div.append($("<span>来自: " + mail.fromAddress + "@" + mail.from + ".nas 的邮件</span>"));
					$div.append($("<br/>"));
					$div.append($("<span>时间: " + new Date(mail.time * 1000).toLocaleString() + "</span>"));
					$div.append($("<br/>"));
					$div.append($("<span>密文内容: </span>"));
					var $contentDiv = $("<div></div>");
					var encryptedContent = mail.content;
					var encryptedContentStr = encryptedContent;
					if (encryptedContent.ciphertext) {
						encryptedContentStr = JSON.stringify(encryptedContent.ciphertext.data);
					}
					$contentDiv.text(encryptedContentStr);
					$div.append($contentDiv);
					if (currentAccount) {
						var privateKey = currentAccount.getPrivateKey();
						if (encryptedContent.ciphertext) {
							encryptedContent.ciphertext = Buffer(encryptedContent.ciphertext.data);
							encryptedContent.ephemPublicKey = Buffer(encryptedContent.ephemPublicKey.data);
							encryptedContent.iv = Buffer(encryptedContent.iv.data);
							encryptedContent.mac = Buffer(encryptedContent.mac.data);
						}
						(function ($div, privateKey, encryptedContent) {
							eccrypto.decrypt(privateKey, encryptedContent).then(function (plaintext) {
								var $decryptedContentDiv = $("<div></div>");
								var decryptedContent = plaintext.toString();
								$decryptedContentDiv.text("原文是: " + decryptedContent);
								$div.append($decryptedContentDiv);
							}).catch(function (e) {
								console.log(e);
							});
						})($div, privateKey, encryptedContent);
					} else {
						var $msg = $("<div><span>原文内容: </span><br/><p>切换到注册域名标签页打开钱包后才能解密查看邮件内容原文</p></div>");
						$div.append($msg);
					}
					$li.append($div);
					$ul.append($li);
				}
				$resultPanel.append($ul);
				$resultPanel.show();
			}).catch(function (err) {
				showErrorInfo(err.message);
			});
		});

		$("#query_user_domains_btn").click(function () {
			var userAddress = $("#query_user_domains_input").val().trim();
			if (!userAddress) {
				showErrorInfo("请输入要查询的地址");
				return;
			}
			var value = "0";
			var gas_price = "1000000"
			var gas_limit = "2000000"
			var callFunction = "getDomainsUserOwned";
			var callArgs = JSON.stringify([userAddress]);
			var contract = {
				"function": callFunction,
				"args": callArgs
			}

			neb.api.call(simulateFromAddress, dappAddress, value, '0', gas_price, gas_limit, contract).then(function (resp) {
				console.log(resp);
				if (resp.execute_err.length > 0) {
					throw new Error(resp.execute_err);
				}
				var result = JSON.parse(resp.result);
				var $resultPanel = $("#query_user_domains_result_panel");
				var $ul = $("<ul></ul>");
				$resultPanel.html('');
				if(result.length<1) {
					showErrorInfo("此地址至今没有拥有星云域名");
					return;
				}
				for (var i = 0; i < result.length; i++) {
					var $li = $("<li></li>");
					$li.text(result[i].host + '.nas');
					$ul.append($li);
				}
				$resultPanel.append($ul);
				$resultPanel.show();
			}).catch(function (err) {
				showErrorInfo(err.message);
			});
		});

		$("#toggle-wallet-show-btn").click(function () {
			var $panel = $("#neb-wallet-panel");
			if ($panel.hasClass('hide')) {
				$panel.removeClass('hide');
			} else {
				$panel.addClass('hide');
			}
		});

		//return of search,
		function cbSearch(resp) {
			var result = resp.result    ////resp is an object, resp.result is a JSON string
			console.log("return of rpc call: " + JSON.stringify(result))

			if (result === 'null') {
				$(".add_banner").addClass("hide");
				$(".result_success").addClass("hide");

				$("#result_faile_add").text($("#search_value").val())

				$(".result_faile").removeClass("hide");
			} else {
				//if result is not null, then it should be "return value" or "error message"
				try {
					result = JSON.parse(result)
				} catch (err) {
					//result is the error message
				}

				if (!!result.key) {      //"return value"
					$(".add_banner").addClass("hide");
					$(".result_faile").addClass("hide");

					$("#search_banner").text($("#search_value").val())
					$("#search_result").text(result.value)
					$("#search_result_author").text(result.author)

					$(".result_success").removeClass("hide");
				} else {        //"error message"
					$(".add_banner").addClass("hide");
					$(".result_faile").addClass("hide");

					$("#search_banner").text($("#search_value").val())
					$("#search_result").text(result)
					$("#search_result_author").text("")

					$(".result_success").removeClass("hide");
				}

			}

		}

		var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
		var nebPay = new NebPay();
		var serialNumber

		$("#push").click(function () {

			var to = dappAddress;
			var value = "0";
			var callFunction = "save"
			var callArgs = "[\"" + $("#search_value").val() + "\",\"" + $("#add_value").val() + "\"]"

			serialNumber = nebPay.call(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
				listener: cbPush        //设置listener, 处理交易返回信息
			});

			startWaitResponse();
		});

		var intervalQuery

		var alertedInstallExtension = false;

		function funcIntervalQuery() {
			nebPay.queryPayInfo(serialNumber)   //search transaction result from server (result upload to server by app)
				.then(function (resp) {
					var respObject = JSON.parse(resp);
					// TODO: 错误处理;
					console.log("tx result: " + resp);   //resp is a JSON string
					if (respObject.code === 0) {
						clearInterval(intervalQuery);
						showErrorInfo("钱包操作完成");
					}
				})
				.catch(function (err) {
					// TODO: 超时处理
					console.log(err);
				});
		}

		function cbPush(resp) {
			showSuccessInfo(resp);
		}

		function showSuccessInfo(msg) {
			if(msg.txhash) {
				showErrorInfo("交易发送成功");
			} else {
				showErrorInfo(msg.toString() || "交易发送成功");
			}
		}

		function startWaitResponse() {
			intervalQuery = setInterval(function () {
				funcIntervalQuery();
			}, 5000);
		}

		$("[go-tab-link]").click(function () {
			var $this = $(this);
			var target = $this.attr('go-tab-link');
			if (target && target.length > 0) {
				$("#" + target).tab('show');
			}
		});

	</script>

	<script src="./js/app.bundle.js?v=1"></script>

</body>

</html>